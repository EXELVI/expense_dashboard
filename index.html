<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .sidebar {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .sidebar .sidebar-heading {
            flex-shrink: 0;
        }

        .sidebar .list-group {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar .dropdown {
            flex-shrink: 0;
        }

        .show-sidebar-btn {
            display: none;
            position: fixed;
            z-index: 1031;

        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 1030;
                left: -250px;
                width: 250px;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .show-sidebar-btn {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="d-flex">
        <!-- Show sidebar button (only on small screens) -->
        <button class="btn btn-primary show-sidebar-btn m-2" id="toggle-sidebar-btn">
            <i class="bi bi-chevron-right"></i>
        </button>

        <!-- Sidebar -->
        <div class="border border-right p-3 sidebar bg-body" id="sidebar-wrapper">
            <div class="sidebar-heading d-flex justify-content-between align-items-center">
                Categories
                <button id="add-category" class="btn btn-success btn-sm"><i class="bi bi-plus-lg"></i></button>
            </div>
            <ul class="nav nav-pills flex-column" id="categories">

            </ul>
            <!-- Footer -->
            <hr>
            <div class="dropdown mt-auto">
                <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="dropdownMenuButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Dropdown Menu
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton">
                    <li><button class="dropdown-item d-flex gap-2 align-items-center" onclick="changeTheme()"><i
                                id="itemTheme" class="bi bi-moon-stars-fill"></i> Change Theme</button></li>
                </ul>
            </div>
        </div>

        <!-- Page Content -->
        <div class="container mt-5">
            <h1 class="text-center mb-4">Expense Dashboard</h1>
            <form id="expense-form" class="row g-3 mb-4" hidden>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="expense-name" placeholder="Expense Name" required>
                </div>
                <div class="col-md-2">
                    <input type="number" step="0.01" class="form-control" id="expense-amount" placeholder="Amount" required>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" id="expense-date" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">Add</button>
                </div>
            </form>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="expense-table">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Amount</th>
                            <th scope="col">Date</th>
                            <th scope="col">Category</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list">
                    </tbody>
                </table>

            </div>
            <div id="total-expense" class="text-end mt-4">
                <h2>Total: â‚¬<span id="total-amount">0</span></h2>
            </div>
            <div class="text-center">
                <img id="barcode" alt="barcode" hidden>
            </div>
        </div>
    </div>



    <!--add category modal-->
    <div class="modal fade" id="modalAddCategory" tabindex="-1" aria-labelledby="modalAddCategory" aria-hidden="true"
        aria-modal="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAddCategoryTitle">Add Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" placeholder="Category Name">
                    <input type="url" class="form-control mb-2" placeholder="URL">
                    <input type="text" class="form-control mb-2" placeholder="Member Card">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="modalAddCategoryBtn">Add</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditCategory" tabindex="-1" aria-labelledby="modalEditCategory" aria-hidden="true"
        aria-modal="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditCategoryTitle">Edit Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" placeholder="Category Name">
                    <input type="url" class="form-control mb-2" placeholder="URL">
                    <input type="text" class="form-control mb-2" placeholder="Member Card">
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-danger" id="deleteCategory">Delete</button>
                    <div class="d-flex">
                        <button type="button" class="btn btn-success me-2" id="modalEditCategoryBtn">Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfirm" tabindex="-1" aria-labelledby="modalConfirm" aria-hidden="true"
        aria-modal="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmTitle">Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalConfirmMessage">Message</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="modalYesBtn">Ok</button>
                    <button type="button" class="btn btn-secondary" id="modalNoBtn"
                        data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function changeTheme(theme) {
            var itemTheme = document.getElementById("itemTheme")
            if (!theme) {
                var themeStorage = localStorage.getItem('theme');
                if (themeStorage != "dark") {
                    document.body.setAttribute('data-bs-theme', "dark");
                    itemTheme.className = "bi bi-sun-fill"
                    localStorage.setItem('theme', "dark");
                } else {
                    document.body.setAttribute('data-bs-theme', "light");
                    itemTheme.className = "bi bi-moon-stars-fill"
                    localStorage.setItem('theme', "light")
                }
            } else if (theme === 'dark' || theme === 'light') {
                document.body.setAttribute('data-bs-theme', theme);
                itemTheme.className = theme === 'dark' ? "bi bi-sun-fill" : "bi bi-moon-stars-fill";
                localStorage.setItem('theme', theme);
            }

            JsBarcode("#barcode", document.getElementById('barcode').alt, {
                background: getComputedStyle(document.body).getPropertyValue('--bs-body-bg'),
                lineColor: getComputedStyle(document.body).getPropertyValue('--bs-emphasis-color'),

            })

        }
        function modalConfirm(title, messageHTML) {
            return new Promise((resolve, reject) => {
                const modal = new bootstrap.Modal(document.getElementById('modalConfirm'));
                document.getElementById('modalConfirmTitle').innerText = title;
                document.getElementById('modalConfirmMessage').innerHTML = messageHTML;

                document.getElementById('modalConfirm').addEventListener('hide.bs.modal', event => {
                    resolve(false);
                })

                const yesBtn = document.getElementById('modalYesBtn');
                const noBtn = document.getElementById('modalNoBtn');

                yesBtn.onclick = () => {
                    resolve(true);
                    modal.hide();
                };

                noBtn.onclick = () => {
                    resolve(false);
                    modal.hide();
                };

                modal.show();
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const expenseForm = document.getElementById('expense-form');
            const expenseNameInput = document.getElementById('expense-name');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseDateInput = document.getElementById('expense-date');
            const expenseList = document.getElementById('expense-list');
            const totalAmountSpan = document.getElementById('total-amount');
            const sidebar = document.getElementById('sidebar-wrapper');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');




            var currentCategory = "all";
            var categories = [
                {
                    name: "all",
                    url: null,
                    expenses: [],
                    memberCard: null
                },
            ]

            function getFaviconUrl(url) {
                if (!url) return '';
                if (!url.startsWith('http')) {
                    url = `http://${url}`;
                }
                const urlObj = new URL(url);
                const faviconUrl = `http://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`;
                return faviconUrl;
            }

            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                toggleSidebarBtn.innerHTML = sidebar.classList.contains('active') ? '<i class="bi bi-chevron-left"></i>' : '<i class="bi bi-chevron-right"></i>';
                //move button,  like it is a part of the sidebar
                let containsActive = sidebar.classList.contains('active');
                for (let i = (containsActive ? 0 : 250); containsActive ? i < 250 : i > 0; containsActive ? i++ : i--) {
                    setTimeout(() => {
                        toggleSidebarBtn.style.left = `${i}px`;
                    }, 0.9 * Math.abs(i - (containsActive ? 0 : 250)));
                }

            });

            let expenses = [];
            let totalAmount = 0;

            function updateTotal() {
                totalAmountSpan.innerText = totalAmount.toFixed(2);
                                
            }



            function displayExpense() {
                const currentCat = categories.filter(c => c.name === currentCategory)[0];
                expenseList.innerHTML = '';
                totalAmount = 0;
                currentCat.expenses.forEach(exp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${exp.name}</td>
                        <td>${exp.amount.toFixed(2)}â‚¬</td>
                        <td>${exp.date}</td>
                        <td>${exp.category}</td>
                        <td>
                            <button class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
                        </td>
                    `;
                    tr.querySelector('button').addEventListener('click', () => {
                        const response = modalConfirm('Delete Expense', `Are you sure you want to delete the expense? <br> <strong>${exp.name} - â‚¬${exp.amount.toFixed(2)}${currentCategory !== "all" ? '' : ` - ${exp.category}`}</strong>`);
                        response.then((result) => {
                            if (result) {
                                categories = categories.map(cat => {
                                    if (cat.name === exp.category) {
                                        cat.expenses = cat.expenses.filter(e => e !== exp);
                                    }
                                    return cat;
                                    console.log(cat)
                                });
                    
                                updateAllCat();
                                updateCurrentCategory(currentCategory);
                                localStorage.setItem('expenses', JSON.stringify(categories.filter(cat => cat.name !== "all")));
                            }
                        });
                    });
                    expenseList.appendChild(tr);
                    totalAmount += exp.amount;
                });
                updateTotal();
            }

            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = expenseNameInput.value;
                const amount = parseFloat(expenseAmountInput.value);
                const date = expenseDateInput.value; // yyyy-mm-dd
                if (name && !isNaN(amount) && date) {
                    const newExpense = {
                        name,
                        amount,
                        date,
                        category: currentCategory
                    };
                    categories = categories.map(cat => {
                        if (cat.name === currentCategory) {
                            cat.expenses.push(newExpense);
                        }
                        return cat;
                    });
                    updateAllCat();
                    updateCurrentCategory(currentCategory);
                    localStorage.setItem('expenses', JSON.stringify(categories.filter(cat => cat.name !== "all")));
                    expenseNameInput.value = '';
                    expenseAmountInput.value = '';
                }
            });

            /*
            { 
                name: 'Amazon', //category
                url: 'https://www.amazon.it', //can be null
                expenses: [ 
                    { name: 'Book', amount: 20, date: '2024-07-27', category: 'Amazon' },
                    { name: 'Headphones', amount: 50, date: '2024-07-27', category: 'Amazon' },
                ],
                memberCard: "80000532", //can be null

            }
            */

            const savedExpenses = JSON.parse(localStorage.getItem('expenses'));


            if (savedExpenses) {
                categories.push(...savedExpenses);
            }

            function updateAllCat() {
                var catt = categories.filter(cat => cat.name === "all")[0];
                catt.expenses = [];
                categories.forEach(cat => {
                    if (cat.name !== "all") {
                        catt.expenses.push(...cat.expenses);
                    }
                });



            }



            function displayCategories() {
                document.getElementById('categories').innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'd-flex justify-content-between align-items-center nav-item ';
                    li.innerHTML = `
                        <a class="nav-link ${cat.name == currentCategory ? 'active' : ''}"><img width="20" src="${cat.url ? getFaviconUrl(cat.url) : ''}" class="me-2">${cat.name == "all" ? "All" : cat.name}</a>`;
                    if (cat.name != "all") {
                        li.innerHTML += `
                              <span>
                            <i class="bi bi-pencil-square text-primary me-2"></i>
                        </span>
                        `;
                    }
                    if (cat.name != "all") {
                        li.querySelector('.bi-pencil-square').addEventListener('click', () => {
                            const modal = new bootstrap.Modal(document.getElementById('modalEditCategory'));
                            modal.show();
                            const name = document.querySelector('#modalEditCategory input')
                            const url = document.querySelector('#modalEditCategory input:nth-of-type(2)')
                            const memberCard = document.querySelector('#modalEditCategory input:nth-of-type(3)')
                            name.value = cat.name;
                            url.value = cat.url;
                            memberCard.value = cat.memberCard;
                            const deleteCategory = document.getElementById('deleteCategory');
                            deleteCategory.addEventListener('click', async () => {
                                const confirm = await modalConfirm('Delete Category', `Are you sure you want to delete the category <strong>${cat.name}</strong>?`);
                                if (confirm) {
                                    categories = categories.filter(c => c.name !== cat.name);
                                    updateAllCat();
                                    updateCurrentCategory("all");
                                    localStorage.setItem('expenses', JSON.stringify(categories.filter(cat => cat.name !== "all")));
                                    modal.hide();
                                }
                            });
                            const editCategoryBtn = document.getElementById('modalEditCategoryBtn');
                            editCategoryBtn.addEventListener('click', () => {
                                const newName = name.value;
                                const newUrl = url.value;
                                const newMemberCard = memberCard.value;
                                if (!newName) {
                                    name.classList.add('is-invalid');
                                    return;
                                } else name.classList.remove('is-invalid');
                                const newCategory = {
                                    name: newName,
                                    url: newUrl,
                                    expenses: cat.expenses,
                                    memberCard: newMemberCard
                                };
                                categories = categories.map(c => c.name === cat.name ? newCategory : c);
                                updateAllCat();
                                updateCurrentCategory(newCategory.name);
                                localStorage.setItem('expenses', JSON.stringify(categories.filter(cat => cat.name !== "all")));
                                modal.hide();
                            });
                        });

                    }
                    li.addEventListener('click', (e) => {
                        e.preventDefault();
                        currentCategory = cat.name;
                        updateAllCat();
                        updateCurrentCategory(cat.name);
                    });
                    document.getElementById('categories').appendChild(li);

                });
            }

            updateAllCat();

            function updateCurrentCategory(cat) {
                if (cat == "all") {
                    document.getElementById('expense-form').hidden = true;
                } else {
                    document.getElementById('expense-form').hidden = false;
                }
                const currentCat = categories.filter(c => c.name === cat)[0];
                expenseList.innerHTML = '';
                totalAmount = 0;
                if (!currentCat.memberCard) {
                    document.getElementById('barcode').hidden = true;
                } else {
                    document.getElementById('barcode').hidden = false;
                    document.getElementById('barcode').alt = currentCat.memberCard;
                    JsBarcode("#barcode", currentCat.memberCard, {
                        background: getComputedStyle(document.body).getPropertyValue('--bs-body-bg'),
                        lineColor: getComputedStyle(document.body).getPropertyValue('--bs-emphasis-color'),

                    })
                }

                displayExpense();
                updateTotal();
                displayCategories();

            }

            updateCurrentCategory(currentCategory);

            const addCategoryBtn = document.getElementById('add-category');
            addCategoryBtn.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('modalAddCategory'));
                modal.show();

                const addCategoryBtn = document.getElementById('modalAddCategoryBtn');
                addCategoryBtn.addEventListener('click', () => {
                    const name = document.querySelector('#modalAddCategory input')
                    const url = document.querySelector('#modalAddCategory input:nth-of-type(2)')
                    const memberCard = document.querySelector('#modalAddCategory input:nth-of-type(3)')
                    if (!name.value) {
                        name.classList.add('is-invalid');
                        return;
                    } else name.classList.remove('is-invalid');
                    const newCategory = {
                        name: name.value,
                        url: url.value,
                        expenses: [],
                        memberCard: memberCard.value
                    };
                    categories.push(newCategory);
                    updateAllCat();
                    updateCurrentCategory(newCategory.name);

                    localStorage.setItem('expenses', JSON.stringify(categories.filter(cat => cat.name !== "all")));
                    name.value = '';
                    url.value = '';
                    memberCard.value = '';
                    modal.hide();

                });





            });

            const savedTheme = localStorage.getItem('theme');
            changeTheme(savedTheme);
        });

    </script>
    <script src="https://cdn.jsdelivr.net/jsbarcode/3.3.3/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>