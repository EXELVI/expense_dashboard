<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .sidebar {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .sidebar .sidebar-heading {
            flex-shrink: 0;
        }

        .sidebar .list-group {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar .dropdown {
            flex-shrink: 0;
        }

        .show-sidebar-btn {
            display: none;
            position: fixed;
            z-index: 1031;

        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 1030;
                left: -250px;
                width: 250px;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .show-sidebar-btn {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="d-flex">
        <!-- Show sidebar button (only on small screens) -->
        <button class="btn btn-primary show-sidebar-btn m-2" id="toggle-sidebar-btn">
            <i class="bi bi-chevron-right"></i>
        </button>

        <!-- Sidebar -->
        <div class="border border-right p-3 sidebar bg-body" id="sidebar-wrapper">
            <div class="sidebar-heading d-flex justify-content-between align-items-center">
                Categories
                <button id="add-category" class="btn btn-success btn-sm"><i class="bi bi-plus-lg"></i></button>
            </div>
            <ul class="list-group list-group-flush nav nav-pills" id="categories">

            </ul>
            <!-- Footer -->
            <hr>
            <div class="dropdown mt-auto">
                <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="dropdownMenuButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Dropdown Menu
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton">
                    <li><button class="dropdown-item d-flex gap-2 align-items-center" onclick="changeTheme()"><i
                                id="itemTheme" class="bi bi-moon-stars-fill"></i> Change Theme</button></li>
                </ul>
            </div>
        </div>

        <!-- Page Content -->
        <div class="container mt-5">
            <h1 class="text-center mb-4">Expense Dashboard</h1>
            <form id="expense-form" class="row g-3 mb-4" hidden>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="expense-name" placeholder="Expense Name" required>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control" id="expense-amount" placeholder="Amount" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">Add</button>
                </div>
            </form>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="expense-table">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Amount</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list">
                    </tbody>
                </table>

            </div>
            <div id="total-expense" class="text-end mt-4">
                <h2>Total: €<span id="total-amount">0</span></h2>
            </div>
            <div class="text-center">
                <img id="barcode" alt="barcode" hidden>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfirm" tabindex="-1" aria-labelledby="modalConfirm" aria-hidden="true"
        aria-modal="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmTitle">Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalConfirmMessage">Message</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="modalYesBtn">Ok</button>
                    <button type="button" class="btn btn-secondary" id="modalNoBtn"
                        data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        function changeTheme(theme) {
            var itemTheme = document.getElementById("itemTheme")
            if (!theme) {
                var themeStorage = localStorage.getItem('theme');
                if (themeStorage != "dark") {
                    document.body.setAttribute('data-bs-theme', "dark");
                    itemTheme.className = "bi bi-sun-fill"
                    localStorage.setItem('theme', "dark");
                } else {
                    document.body.setAttribute('data-bs-theme', "light");
                    itemTheme.className = "bi bi-moon-stars-fill"
                    localStorage.setItem('theme', "light")
                }
            } else if (theme === 'dark' || theme === 'light') {
                document.body.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
            }
        }
        function modalConfirm(title, messageHTML) {
            return new Promise((resolve, reject) => {
                const modal = new bootstrap.Modal(document.getElementById('modalConfirm'));
                document.getElementById('modalConfirmTitle').innerText = title;
                document.getElementById('modalConfirmMessage').innerHTML = messageHTML;

                document.getElementById('modalConfirm').addEventListener('hide.bs.modal', event => {
                    resolve(false);
                })

                const yesBtn = document.getElementById('modalYesBtn');
                const noBtn = document.getElementById('modalNoBtn');

                yesBtn.onclick = () => {
                    resolve(true);
                    modal.hide();
                };

                noBtn.onclick = () => {
                    resolve(false);
                    modal.hide();
                };

                modal.show();
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const expenseForm = document.getElementById('expense-form');
            const expenseNameInput = document.getElementById('expense-name');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseList = document.getElementById('expense-list');
            const totalAmountSpan = document.getElementById('total-amount');
            const sidebar = document.getElementById('sidebar-wrapper');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');




            var currentCategory = "all";
            var categories = [
                {
                    name: "all",
                    url: null,
                    expenses: [],
                    memberCard: null
                },
            ]

            function getFaviconUrl(url) {
                const urlObj = new URL(url);
                const faviconUrl = `${urlObj.origin}/favicon.ico`;
                return faviconUrl;
            }

            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                toggleSidebarBtn.innerHTML = sidebar.classList.contains('active') ? '<i class="bi bi-chevron-left"></i>' : '<i class="bi bi-chevron-right"></i>';
                //move button,  like it is a part of the sidebar
                let containsActive = sidebar.classList.contains('active');
                for (let i = (containsActive ? 0 : 250); containsActive ? i < 250 : i > 0; containsActive ? i++ : i--) {
                    setTimeout(() => {
                        toggleSidebarBtn.style.left = `${i}px`;
                    }, 0.9 * Math.abs(i - (containsActive ? 0 : 250)));
                }

            });

            let expenses = [];
            let totalAmount = 0;

            function updateTotal() {
                totalAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                totalAmountSpan.textContent = totalAmount.toFixed(2);
            }

            function addExpense(name, amount) {
                const expense = { name, amount };
                expenses.push(expense);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${name}</td>
                    <td>€${amount.toFixed(2)}</td>
                    <td><button class="delete-btn">Elimina</button></td>
                `;
                row.scope = "row";
                expenseList.appendChild(row);

                row.querySelector('.delete-btn').addEventListener('click', () => {
                    expenses = expenses.filter(e => e !== expense);
                    row.remove();
                    updateTotal();
                });

                updateTotal();
            }

            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = expenseNameInput.value;
                const amount = parseFloat(expenseAmountInput.value);
                if (name && !isNaN(amount) && amount > 0) {
                    addExpense(name, amount);
                    expenseNameInput.value = '';
                    expenseAmountInput.value = '';
                }
            });

            /*
            { 
                name: 'Amazon', //category
                url: 'https://www.amazon.it', //can be null
                expenses: [ 
                    { name: 'Book', amount: 20 },
                    { name: 'Headphones', amount: 50 }
                ],
                memberCard: "80000532", //can be null

            }
            */

            // Load saved from storage
            const savedExpenses = JSON.parse(localStorage.getItem('expenses'));


            if (savedExpenses) {
                categories.push(...savedExpenses);
            }

            function updateAllCat() {
                var catt = categories.filter(cat => cat.name === "all")[0];
                var all = {
                    name: "all",
                    url: null,
                    expenses: [],
                    memberCard: null
                }

                catt.expenses.forEach(exp => {
                    all.expenses.push(exp);
                });

                categories[0] = all;
            }



            function displayCategories() {
                document.getElementById('categories').innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center nav-item ';
                    li.innerHTML = `
                        <a class="nav-link ${cat.name == currentCategory ? 'active' : ''}">${cat.name == "all" ? "All" : cat.name}</a>`;
                    if (cat.name != "all") {
                        li.innerHTML += `
                              <span>
                            <i class="bi bi-pencil-square text-primary me-2"></i>
                            <i class="bi bi-trash text-danger" hidden></i>
                        </span>
                        `;
                    }
                    if (cat.name != "all") {
                        li.querySelector('.bi-pencil-square').addEventListener('click', () => {
                            const inputHtml = `<input type="text" class="form-control" value="${cat.name}">`;
                            const response = modalConfirm('Edit Category', inputHtml);
                            response.then((result) => {
                                if (result) {
                                    const newName = document.querySelector('#modalConfirmMessage input').value;
                                    cat.name = newName;
                                    li.querySelector('span').textContent = newName;
                                    updateAllCat();
                                }
                            });
                        });
                        li.querySelector('.bi-trash').addEventListener('click', () => {
                            const response = modalConfirm('Delete Category', `Are you sure you want to delete the category ${cat.name}?`);
                            response.then((result) => {
                                if (result) {
                                    categories = categories.filter(c => c !== cat);
                                    li.remove();
                                    updateAllCat();
                                }
                            });
                        });
                    }
                    li.addEventListener('click', (e) => {
                        e.preventDefault();
                        currentCategory = cat.name;
                        updateAllCat();
                        updateCurrentCategory(cat.name);
                    });
                    document.getElementById('categories').appendChild(li);
                });
            }

            updateAllCat();

            function updateCurrentCategory(cat) {
                if (cat == "all") {
                    document.getElementById('expense-form').hidden = true;
                } else {
                    document.getElementById('expense-form').hidden = false;
                }
                const currentCat = categories.filter(c => c.name === cat)[0];
                expenseList.innerHTML = '';
                totalAmount = 0;
                if (!currentCat.memberCard) {
                    document.getElementById('barcode').hidden = true;
                } else {
                    document.getElementById('barcode').hidden = false;
                    JsBarcode("#barcode", currentCat.memberCard);
                }
                
                currentCat.expenses.forEach(exp => {
                    addExpense(exp.name, exp.amount);
                });
                updateTotal();
                displayCategories();

            }

            updateCurrentCategory(currentCategory);


        });
        const savedTheme = localStorage.getItem('theme');
        changeTheme(savedTheme);
    </script>
    <script src="https://cdn.jsdelivr.net/jsbarcode/3.3.3/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>